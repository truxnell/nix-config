# Secrets

Secrets is always a challenge for systems that work like Infrastructure-as-Code (IAC).  I have taken the approach of using [sops-nix](https://github.com/Mic92/sops-nix) as I am familiar with the [sops](https://github.com/getsops/sops) project, like it and like the [age](https://github.com/FiloSottile/age) key system.

How im using sops-nix is:

* Take a encrypted file that is in a folder/repo
* Upon `nixos-rebuild` commands decrypt the file with the hosts ssh key
* Place the unencrypted file in `/run/secrets/` folder with specific user/group/permissions
* Services can then reference this files in a number of ways to ingest the secret.

# Setup

There are setup instructions in for a initial setup of sops-nix in the repository.  At a core, you will want to 
* Get sops-nix into your flake (Docs at: https://github.com/Mic92/sops-nix)
* Create the `.sops.yaml` file in the root of the git repo (Docs at: https://github.com/Mic92/sops-nix)
* Populate keys from hosts (preferably by `nix-shell -p ssh-to-age --run 'cat /etc/ssh/ssh_host_ed25519_key.pub | ssh-to-age'` on each host)
* Encrypt each secret in a `secrets.sops.yaml` file (`sops -e -i path/to/file/filename.sops.yaml)
* Populate secrets in your nix 

!!! Info
 
        I have chosen to let each host have a unique age key, generated by its ssh-key, which is generated unique by nix at install.  This means I have a key per host in my `.sops.yaml` file, and each machine can decrypt the secret with its own key.
        Another approach is to generate one master key, which Is then pushed to each machine.  I chose not to do this as there is some small security benefit of having a unique key per host.

## Adding new hosts

On new machine, run below to transfer its shiny new ed25519 to age

```sh
nix-shell -p ssh-to-age --run 'cat /etc/ssh/ssh_host_ed25519_key.pub | ssh-to-age'
```

Copy this into `./.sops.yaml` in base repo, then re-run taskfile `task sops:re-encrypt` to loop through all sops keys, decrypt then re-encrypt
